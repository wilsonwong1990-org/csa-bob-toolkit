name: Weekly Snippets â€” Open Issue

on:
  schedule:
    # Every Monday at 9:00 AM UTC (adjust for your timezone)
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  open-weekly-snippets-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate week-ending Friday date
        id: dates
        run: |
          # Calculate this coming Friday (days until Friday from Monday = 4)
          friday=$(date -u -d "next Friday" +%Y-%m-%d 2>/dev/null || date -u -v+Fri +%Y-%m-%d)
          echo "friday=$friday" >> $GITHUB_OUTPUT

      - name: Check for existing open snippets issue
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              ...context.repo,
              labels: 'weekly-snippets',
              state: 'open',
              per_page: 1
            });
            core.setOutput('exists', issues.length > 0 ? 'true' : 'false');

      - name: Create weekly-snippets label if missing
        if: steps.check.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.createLabel({
                ...context.repo,
                name: 'weekly-snippets',
                color: '7057ff',
                description: 'Weekly snippet tracking issue'
              });
            } catch (error) {
              if (error.status !== 422) throw error; // 422 = already exists
            }

      - name: Install js-yaml for YAML parsing
        if: steps.check.outputs.exists == 'false'
        run: npm install js-yaml

      - name: Open weekly snippets issue
        if: steps.check.outputs.exists == 'false'
        uses: actions/github-script@v7
        env:
          FRIDAY: ${{ steps.dates.outputs.friday }}
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');
            const friday = process.env.FRIDAY;

            // Parse the issue template YAML as the single source of truth
            const templatePath = '.github/ISSUE_TEMPLATE/weekly-snippets.yml';
            const template = yaml.load(fs.readFileSync(templatePath, 'utf8'));

            // Build the title from the template, replacing the placeholder
            const title = template.title.replace('<YYYY-MM-DD>', friday);

            // Build the issue body from the template fields
            const bodyParts = [
              `## Weekly Snippets â€” Supplemental Context`,
              ``,
              `**Week ending:** ${friday}`,
              ``,
              `Use this issue to add details you want included in this week's snippet that may not be captured in meeting notes. The **Weekly Snippets Agent** will combine this with meeting notes to generate your Friday update.`,
              ``,
              `All fields are optional â€” only fill in what's relevant this week.`,
              ``,
              `---`
            ];

            // Extract textarea fields from the template and render as sections
            for (const field of template.body) {
              if (field.type === 'textarea') {
                const label = field.attributes.label;
                const description = field.attributes.description || '';
                const placeholder = (field.attributes.placeholder || '').trim();

                bodyParts.push(``);
                bodyParts.push(`### ${label}`);
                bodyParts.push(`<!-- ${description} -->`);
                bodyParts.push(``);
                if (placeholder) {
                  bodyParts.push(`<!-- Example:`);
                  bodyParts.push(`${placeholder}`);
                  bodyParts.push(`-->`);
                  bodyParts.push(``);
                }
                bodyParts.push(`_None yet â€” edit this section to add._`);
              }
            }

            bodyParts.push(``);
            bodyParts.push(`---`);
            bodyParts.push(``);
            bodyParts.push(`> ðŸ’¡ **Tip:** Edit this issue throughout the week as things come up. On Friday, run the Weekly Snippets Agent to compile everything.`);

            await github.rest.issues.create({
              ...context.repo,
              title,
              labels: template.labels || ['weekly-snippets'],
              body: bodyParts.join('\n')
            });
